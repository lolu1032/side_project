<!DOCTYPE html>
<html>
<head>
    <title>ì¿ í° ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .status-box {
            border: 1px solid #ddd;
            padding: 20px;
            margin: 10px 0;
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        .waiting {
            background-color: #fff3cd;
            border-color: #ffeaa7;
            border-left: 4px solid #ffc107;
        }
        .processing {
            background-color: #d4edda;
            border-color: #c3e6cb;
            border-left: 4px solid #28a745;
        }
        .completed {
            background-color: #d1ecf1;
            border-color: #bee5eb;
            border-left: 4px solid #17a2b8;
        }
        .failed {
            background-color: #f8d7da;
            border-color: #f5c6cb;
            border-left: 4px solid #dc3545;
        }
        button {
            padding: 12px 24px;
            margin: 5px;
            cursor: pointer;
            border: none;
            border-radius: 5px;
            background-color: #007bff;
            color: white;
            font-size: 14px;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        input {
            padding: 12px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
            width: 200px;
        }
        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        .spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 2s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        h1 {
            text-align: center;
            color: #333;
            margin-bottom: 30px;
        }
        h2 {
            color: #555;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 10px 0;
        }
        .progress-fill {
            height: 100%;
            background-color: #28a745;
            transition: width 0.3s ease;
        }
        .info-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 5px;
            text-align: center;
        }
        .info-item .number {
            font-size: 24px;
            font-weight: bold;
            color: #007bff;
        }
        .info-item .label {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        @media (max-width: 600px) {
            .input-group {
                flex-direction: column;
                align-items: stretch;
            }
            input {
                width: 100%;
                margin: 5px 0;
            }
            .info-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
<h1>ğŸ« ì¿ í° ëŒ€ê¸°ì—´ ì‹œìŠ¤í…œ</h1>

<div class="container">
    <h2>ğŸ“¦ ì¬ê³  ê´€ë¦¬</h2>
    <div class="input-group">
        <input type="number" id="promotionId" placeholder="í”„ë¡œëª¨ì…˜ ID" value="1">
        <input type="number" id="stockAmount" placeholder="ì¬ê³  ìˆ˜ëŸ‰" value="100">
        <button onclick="initStock()">ì¬ê³  ì´ˆê¸°í™”</button>
    </div>
</div>

<div class="container">
    <h2>ğŸš€ ëŒ€ê¸°ì—´ ì°¸ì—¬</h2>
    <div class="input-group">
        <input type="number" id="userId" placeholder="ì‚¬ìš©ì ID" value="">
        <button onclick="joinQueue()" id="joinBtn">ëŒ€ê¸°ì—´ ì°¸ì—¬</button>
        <button onclick="stopPolling()" id="stopBtn" style="background-color: #dc3545;" disabled>ì¤‘ì§€</button>
    </div>

    <div id="status-display" class="status-box">
        <h3>ğŸ’¡ ì•ˆë‚´</h3>
        <p>ì‚¬ìš©ì IDë¥¼ ì…ë ¥í•˜ê³  'ëŒ€ê¸°ì—´ ì°¸ì—¬' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
        <p>ëŒ€ê¸°ì—´ì— ì°¸ì—¬í•˜ë©´ ì‹¤ì‹œê°„ìœ¼ë¡œ ìƒíƒœê°€ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
    </div>
</div>

<div class="container">
    <h2>ğŸ“Š í ì •ë³´</h2>
    <button onclick="getQueueInfo()">í ì •ë³´ ìƒˆë¡œê³ ì¹¨</button>
    <div id="queue-info" class="status-box">
        <p>í ì •ë³´ë¥¼ ì¡°íšŒí•˜ë ¤ë©´ ìœ„ì˜ ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
    </div>
</div>

<script>
    let pollingInterval = null;
    let currentUserId = null;
    let currentPromotionId = 1;

    // ì‚¬ìš©ì ID ìë™ ìƒì„±
    document.getElementById('userId').value = Math.floor(Math.random() * 10000);

    // ì¬ê³  ì´ˆê¸°í™”
    async function initStock() {
        const promotionId = document.getElementById('promotionId').value;
        const stock = document.getElementById('stockAmount').value;

        if (!promotionId || !stock) {
            alert('í”„ë¡œëª¨ì…˜ IDì™€ ì¬ê³  ìˆ˜ëŸ‰ì„ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        try {
            const response = await fetch('/api/coupon/queue/init-stock', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({promotionId: parseInt(promotionId), stock: parseInt(stock)})
            });

            const result = await response.json();

            if (result.status === "SUCCESS") {
                alert('âœ… ì¬ê³ ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤!');
                getQueueInfo();
            } else {
                alert('âŒ ì¬ê³  ì´ˆê¸°í™” ì‹¤íŒ¨: ' + result.message);
            }
        } catch (error) {
            console.error('ì¬ê³  ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            alert('ğŸ”Œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        }
    }

    // ëŒ€ê¸°ì—´ ì°¸ì—¬
    async function joinQueue() {
        const userId = document.getElementById('userId').value;
        const promotionId = document.getElementById('promotionId').value;

        if (!userId || !promotionId) {
            alert('ì‚¬ìš©ì IDì™€ í”„ë¡œëª¨ì…˜ IDë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
            return;
        }

        // ë²„íŠ¼ ë¹„í™œì„±í™”
        const joinBtn = document.getElementById('joinBtn');
        const stopBtn = document.getElementById('stopBtn');
        joinBtn.disabled = true;
        stopBtn.disabled = false;

        try {
            const response = await fetch('/api/coupon/queue/join', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({promotionId: parseInt(promotionId), userId: parseInt(userId)})
            });

            const result = await response.json();

            if (result.status === "SUCCESS") {
                currentUserId = parseInt(userId);
                currentPromotionId = parseInt(promotionId);

                updateStatusDisplay(result);
                startPolling();
            } else {
                alert('âŒ ëŒ€ê¸°ì—´ ì°¸ì—¬ ì‹¤íŒ¨: ' + result.message);
                resetButtons();
            }
        } catch (error) {
            console.error('ëŒ€ê¸°ì—´ ì°¸ì—¬ ì˜¤ë¥˜:', error);
            alert('ğŸ”Œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            resetButtons();
        }
    }

    // ìƒíƒœ í™•ì¸ í´ë§ ì‹œì‘
    function startPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
        }

        // 2ì´ˆë§ˆë‹¤ ìƒíƒœ í™•ì¸
        pollingInterval = setInterval(async () => {
            await checkStatus();
            await getQueueInfo(); // í ì •ë³´ë„ í•¨ê»˜ ì—…ë°ì´íŠ¸
        }, 2000);

        // ì¦‰ì‹œ ì‹¤í–‰
        checkStatus();
    }

    // ìƒíƒœ í™•ì¸
    async function checkStatus() {
        if (!currentUserId || !currentPromotionId) return;

        try {
            const response = await fetch(`/api/coupon/queue/status?promotionId=${currentPromotionId}&userId=${currentUserId}`);
            const result = await response.json();

            if (result.status === "SUCCESS") {
                updateStatusDisplay(result);

                // ì™„ë£Œ ë˜ëŠ” ì‹¤íŒ¨ ì‹œ í´ë§ ì¤‘ì§€
                if (result.data.status === 'COMPLETED' || result.data.status === 'FAILED') {
                    stopPolling();
                }
            }
        } catch (error) {
            console.error('ìƒíƒœ í™•ì¸ ì˜¤ë¥˜:', error);
        }
    }

    // í´ë§ ì¤‘ì§€
    function stopPolling() {
        if (pollingInterval) {
            clearInterval(pollingInterval);
            pollingInterval = null;
        }
        resetButtons();
    }

    // ë²„íŠ¼ ìƒíƒœ ë¦¬ì…‹
    function resetButtons() {
        const joinBtn = document.getElementById('joinBtn');
        const stopBtn = document.getElementById('stopBtn');
        joinBtn.disabled = false;
        stopBtn.disabled = true;
    }

    // ìƒíƒœ í™”ë©´ ì—…ë°ì´íŠ¸
    function updateStatusDisplay(result) {
        const statusElement = document.getElementById('status-display');
        const data = result.data;

        let html = '';
        let className = 'status-box ';

        if (data.status) {
            // QueueStatus ê°ì²´ì¸ ê²½ìš°
            switch (data.status) {
                case 'WAITING':
                    className += 'waiting';
                    const progress = Math.max(0, 100 - (data.position / data.totalWaiting * 100));
                    html = `
                        <h3>â³ ëŒ€ê¸° ì¤‘</h3>
                        <p><strong>${data.message}</strong></p>
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <p>ì´ ëŒ€ê¸°ì¸ì›: <strong>${data.totalWaiting}ëª…</strong></p>
                    `;
                    break;

                case 'PROCESSING':
                    className += 'processing';
                    html = `
                        <h3>âš¡ ì²˜ë¦¬ ì¤‘</h3>
                        <p><strong>${data.message}</strong></p>
                        <div class="spinner"></div>
                        <p>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš”...</p>
                    `;
                    break;

                case 'COMPLETED':
                    className += 'completed';
                    html = `
                        <h3>ğŸ‰ ë°œê¸‰ ì™„ë£Œ!</h3>
                        <p><strong>${data.message}</strong></p>
                        <p>ì¶•í•˜í•©ë‹ˆë‹¤! ì¿ í°ì´ ì„±ê³µì ìœ¼ë¡œ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤.</p>
                        <button onclick="location.reload()">ìƒˆë¡œê³ ì¹¨</button>
                    `;
                    break;

                case 'FAILED':
                    className += 'failed';
                    html = `
                        <h3>âŒ ë°œê¸‰ ì‹¤íŒ¨</h3>
                        <p><strong>${data.message}</strong></p>
                        <p>ì•„ì‰½ê²Œë„ ì¿ í° ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ê¸°íšŒì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>
                        <button onclick="location.reload()">ë‹¤ì‹œ ì‹œë„</button>
                    `;
                    break;

                case 'NOT_IN_QUEUE':
                    html = `
                        <h3>â„¹ï¸ ëŒ€ê¸°ì—´ ë¯¸ë“±ë¡</h3>
                        <p><strong>${data.message}</strong></p>
                        <p>ëŒ€ê¸°ì—´ì— ì°¸ì—¬í•˜ë ¤ë©´ ìœ„ì˜ 'ëŒ€ê¸°ì—´ ì°¸ì—¬' ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</p>
                    `;
                    break;

                default:
                    html = `<h3>â“ ì•Œ ìˆ˜ ì—†ëŠ” ìƒíƒœ</h3><p>${data.message || 'ìƒíƒœë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.'}</p>`;
            }
        } else {
            // QueuePosition ê°ì²´ì¸ ê²½ìš° (ì°¸ì—¬ ì§í›„)
            className += 'waiting';
            html = `
                <h3>âœ… ëŒ€ê¸°ì—´ ë“±ë¡ ì™„ë£Œ</h3>
                <p><strong>${result.message}</strong></p>
                <p>ëŒ€ê¸° ìˆœë²ˆ: <strong>${data.position}ë²ˆ</strong></p>
                <p>ìƒíƒœê°€ ì‹¤ì‹œê°„ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë©ë‹ˆë‹¤.</p>
            `;
        }

        statusElement.className = className;
        statusElement.innerHTML = html;
    }

    // í ì •ë³´ ì¡°íšŒ
    async function getQueueInfo() {
        const promotionId = document.getElementById('promotionId').value;

        if (!promotionId) return;

        try {
            const response = await fetch(`/api/coupon/queue/info?promotionId=${promotionId}`);
            const result = await response.json();

            if (result.status === "SUCCESS") {
                updateQueueInfoDisplay(result.data);
            } else {
                document.getElementById('queue-info').innerHTML =
                    `<p>âŒ í ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨: ${result.message}</p>`;
            }
        } catch (error) {
            console.error('í ì •ë³´ ì¡°íšŒ ì˜¤ë¥˜:', error);
            document.getElementById('queue-info').innerHTML =
                '<p>ğŸ”Œ ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ í ì •ë³´ë¥¼ ì¡°íšŒí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>';
        }
    }

    // í ì •ë³´ í™”ë©´ ì—…ë°ì´íŠ¸
    function updateQueueInfoDisplay(data) {
        const queueInfoElement = document.getElementById('queue-info');

        const html = `
            <h3>ğŸ“Š í”„ë¡œëª¨ì…˜ ${data.promotionId} í˜„í™©</h3>
            <div class="info-grid">
                <div class="info-item">
                    <div class="number">${data.currentStock}</div>
                    <div class="label">ë‚¨ì€ ì¬ê³ </div>
                </div>
                <div class="info-item">
                    <div class="number">${data.queueSize}</div>
                    <div class="label">ëŒ€ê¸° ì¤‘</div>
                </div>
                <div class="info-item">
                    <div class="number">${data.processingCount}</div>
                    <div class="label">ì²˜ë¦¬ ì¤‘</div>
                </div>
                <div class="info-item">
                    <div class="number">${data.currentStock > 0 ? 'ğŸŸ¢' : 'ğŸ”´'}</div>
                    <div class="label">ì¬ê³  ìƒíƒœ</div>
                </div>
            </div>
            <p><small>ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString()}</small></p>
        `;

        queueInfoElement.innerHTML = html;
    }

    // í˜ì´ì§€ ë¡œë“œ ì‹œ í ì •ë³´ ì¡°íšŒ
    window.onload = function() {
        getQueueInfo();
    };

    // í˜ì´ì§€ ë– ë‚  ë•Œ í´ë§ ì¤‘ì§€
    window.onbeforeunload = function() {
        stopPolling();
    };
</script>
</body>
</html>