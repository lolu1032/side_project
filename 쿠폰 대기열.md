#  Coupon Queue System

쿠폰 발급 시 **대기열(Queue) 기반 처리**를 구현한 시스템입니다.  
Redis를 활용하여 **대기열 관리**, **재고 관리**, **비동기 쿠폰 발급**을 처리합니다.  

---

##  아키텍처 개요
```plaintext
[사용자 요청]
   ↓
CouponQueueController
   ↓
CouponQueueService
   - 대기열 추가 (Redis List)
   - 상태 조회
   - 배치 처리 (Scheduled)
   - 쿠폰 발급 비동기 처리
   ↓
CouponV2RedisService.issue()
   - Redis 재고 차감
   - 대기열에 발급 요청 push
```
# 주요 기능
1. 대기열 참여
Endpoint: POST /api/coupon/queue/join

사용자를 특정 프로모션의 대기열에 추가합니다.

이미 발급 완료/실패/처리 중인 사용자는 새로운 대기열에 등록되지 않습니다.

응답 예시:

```json
{
  "success": true,
  "message": "대기열 5번으로 등록되었습니다.",
  "data": {
    "position": 5,
    "status": "WAITING"
  }
}
```
# 2. 대기열 상태 조회
Endpoint: GET /api/coupon/queue/status?promotionId=1&userId=100

사용자의 현재 상태를 조회합니다.

상태 종류:

- `WAITING` : 대기열에 있으며 순번 대기 중
- `PROCESSING` : 발급 처리 중
- `COMPLETED` : 발급 성공
- `FAILED` : 발급 실패 (재고 부족 등)
- `NOT_IN_QUEUE` : 대기열에 없음

# 3. 재고 초기화
Endpoint: POST /api/coupon/queue/init-stock

특정 프로모션의 쿠폰 재고를 초기화합니다.

요청 예시:

```json
{
  "promotionId": 1,
  "stock": 1000
}
```
# 4. 큐 정보 조회
Endpoint: GET /api/coupon/queue/info?promotionId=1

특정 프로모션의 전체 큐 상태를 조회합니다.

응답 예시:

```json
{
  "success": true,
  "message": "큐 정보 조회 성공",
  "data": {
    "promotionId": 1,
    "currentStock": 950,
    "queueSize": 120,
    "processingCount": 50
  }
}
```
# 내부 동작 방식
1. 대기열 관리
- `coupon:waiting_queue:{promotionId}` : Redis List → 대기열 사용자 관리 (FIFO)
- `coupon:processing:{promotionId}` : Redis Set → 발급 처리 중인 사용자
- `coupon:user_status:{promotionId}:{userId}` : Redis String → 사용자 상태 저장
- `{promotionId}` : Redis String → 해당 프로모션의 재고 수량

2. 배치 처리
- `@Scheduled(fixedDelay = 1000)`
- 1초마다 각 프로모션별 대기열에서 최대 `BATCH_SIZE`(기본 100명)까지 꺼내 처리
- 재고가 부족하면 나머지 대기자는 모두 `FAILED` 상태로 처리

3. 비동기 발급
- `@Async("taskExecutor")` 기반으로 `processUserCouponAsync()` 실행
- Redis 재고 차감 시도 후, 성공이면 상태 `"COMPLETED"`, 실패면 `"FAILED"`

#  Redis Key 설계
| Key | Type | 설명 |
| --- | --- | --- |
| `coupon:waiting_queue:{promotionId}` | List | 대기열 사용자 (FIFO) |
| `coupon:processing:{promotionId}` | Set | 현재 발급 처리 중인 사용자 |
| `coupon:user_status:{promotionId}:{userId}` | String | 사용자 상태 (WAITING, PROCESSING, COMPLETED, FAILED) |
| `{promotionId}` | String | 해당 프로모션의 재고 수량 |

#  처리 시나리오
1. 사용자 A가 대기열 참여 요청
2. `coupon:waiting_queue:{promotionId}` 리스트에 `push`
3. 상태 `WAITING` 저장
4. 배치 스케줄러가 A를 큐에서 꺼냄
5. `coupon:processing:{promotionId}` 에 추가
6. 상태 `PROCESSING` 저장
7. 비동기 발급 시도
   - 재고 차감 성공 → `COMPLETED`
   - 재고 부족/에러 → `FAILED`
8. 완료 후 `processing` 세트에서 제거

#  주의사항 & 개선 포인트
- **재고 차감 원자성** → 현재 `decrement` / `increment` 조합은 race condition 가능 → **Lua Script 사용 권장**
- **중복 요청 방지** → Redis `SETNX` 또는 DB `UNIQUE` 제약조건 필요
- **장애 대응** → DB 저장 실패 시 **DLQ(Dead Letter Queue)** 적용 가능
- **확장성** → Redis List 대신 **Kafka, RabbitMQ** 등 메시지 큐로 교체 가능
